<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 900px;
      margin-bottom: 20px;
    }
    .tab-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .tab-buttons button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    .tab-buttons button:hover,
    .tab-buttons button.active {
      background: #ff9800;
      color: #000;
    }
    .tab {
      display: none;
      max-width: 900px;
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    .tab.active {
      display: block;
    }
    .info-box {
      background: rgba(255,255,255,0.2);
      border-left: 4px solid orange;
      padding: 15px;
      margin-top: 20px;
      border-radius: 10px;
    }
    .info-box h4 {
      margin: 0 0 10px;
      color: #fff;
    }
    .info-box ul {
      margin: 0;
      padding-left: 20px;
      color: #eee;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h2 id="welcome">Welcome, User</h2>
    <button onclick="logout()" 
  style="
    padding: 4px 12px;       /* less vertical padding */
    font-size: 14px;
    border-radius: 20px;     /* more rounded */
    background: #f44336; 
    color: white; 
    border: none; 
    cursor: pointer;
    min-width: 80px;         /* narrower */
    height: 30px;            /* fixed shorter height */
    line-height: 22px;       /* vertically center text */
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  ">
  Sign Out
</button>
  </div>

  <div class="tab-buttons">
    <button class="active" onclick="showTab('link', this)">Your Link</button>
    <button onclick="showTab('messages', this)">Messages</button>
    <button onclick="showTab('settings', this)">Settings</button>
  </div>
  <div id="link" class="tab active">
    <h3>Your Chat Link</h3>
    <input type="text" id="shareLink" readonly style="width:100%; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: none;" />
    <button onclick="copyLink()">Copy Link</button>

    <div class="info-box">
      <h4>üéØ Add it to your Instagram Profile</h4>
      <ul>
        <li>Open your Instagram app.</li>
        <li>Go to your profile page.</li>
        <li>Tap ‚ÄúEdit Profile‚Äù.</li>
        <li>Paste your chat link into the ‚ÄúWebsite‚Äù field.</li>
        <li>Save changes. Now it‚Äôs visible on your profile!</li>
      </ul>
    </div>

    <div class="info-box">
      <h4>üéØ Add it to your Instagram Story</h4>
      <ul>
        <li>Create a new story.</li>
        <li>Tap the ‚ÄúLink‚Äù sticker.</li>
        <li>Paste your chat link there.</li>
        <li>Place the sticker wherever you want on the story.</li>
        <li>Share your story. Followers can now tap to chat!</li>
      </ul>
    </div>
  </div>
  <div id="messages" class="tab">
    <h3>Your Messages</h3>
    <div id="chatList"></div>

    <div id="chatView" style="display:none; margin-top: 20px;">
      <button onclick="closeChat()" style="margin-bottom: 10px;">‚úñÔ∏è Close Chat</button>
      <div class="chatbox" id="chatBox" style="background: rgba(255, 255, 255, 0.2); padding: 10px; border-radius: 10px; height: 200px; overflow-y: auto; margin-bottom: 10px;"></div>
      <div style="display: flex; gap: 10px;">
        <textarea id="replyBox" placeholder="Reply..." style="flex: 1; padding: 10px; border-radius: 8px; border: none;"></textarea>
        <button onclick="sendReply()" style="background: #00bcd4; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Send</button>
      </div>
    </div>
  </div>
  <div id="settings" class="tab">
    <h3>Settings</h3>
    <input type="text" id="newUsername" placeholder="New Username" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:none;" />
    <input type="password" id="currentPassword" placeholder="Current Password" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:none;" />
    <button onclick="changeUsername()" style="background: #ff5722; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">Change Username</button>
    <p id="status" style="margin-top:10px;"></p>
  </div>
  <script>
  const user = localStorage.getItem("loggedInUser");
  if (!user) window.location.href = "login.html";

  document.getElementById("welcome").textContent = "Welcome, " + user;
  document.getElementById("shareLink").value = location.origin + "/chat.html?user=" + user;

  function showTab(tabId, btn) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  function logout() {
    localStorage.removeItem("loggedInUser");
    window.location.href = "index.html";
  }

  function copyLink() {
    const input = document.getElementById("shareLink");
    input.select();
    navigator.clipboard.writeText(input.value).then(() => alert("Link copied!"));
  }

  const listRef = firebase.database().ref("chats/" + user);
  let previousUnseen = 0;

  listRef.on("value", snap => {
    const chatList = document.getElementById("chatList");
    chatList.innerHTML = "";
    const data = snap.val();
    let unseenCount = 0;

    if (!data) {
      chatList.innerHTML = "<p>No messages yet.</p>";
      return;
    }

    const sortedEntries = Object.entries(data).sort((a, b) => {
      const msgsA = a[1].messages;
      const msgsB = b[1].messages;
      const lastTimeA = msgsA ? Object.values(msgsA).slice(-1)[0]?.time : 0;
      const lastTimeB = msgsB ? Object.values(msgsB).slice(-1)[0]?.time : 0;
      return new Date(lastTimeB) - new Date(lastTimeA);
    });

    for (let [deviceId, chat] of sortedEntries) {
      const messages = chat.messages;
      if (!messages) continue;

      const seen = chat.seen || false;
      if (!seen) unseenCount++;

      const container = document.createElement("div");
      container.style = "border:1px solid #ccc;padding:10px;margin:10px 0;border-radius:8px;background: rgba(255,255,255,0.1);position: relative;";
      if (!seen) container.style.background = "#fff6c1";

      container.innerHTML = `
        <strong style="display:block;font-size:16px;">${deviceId}</strong>
        <button onclick="openChat('${deviceId}')" style="margin-top:8px;background:#4caf50;color:white;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;">Open</button>
        <div style="position:absolute;top:10px;right:10px;">
          <div style="position: relative;">
            <button onclick="toggleMenu(this)" style="background:none;border:none;color:white;font-size:18px;cursor:pointer;">‚ãÆ</button>
            <div class="menu" style="display:none;position:absolute;top:100%;right:0;background:white;color:black;padding:5px 10px;border-radius:5px;box-shadow:0 0 10px rgba(0,0,0,0.2);">
              <button onclick="deleteChat('${deviceId}')" style="background:none;border:none;color:red;cursor:pointer;">Delete</button>
            </div>
          </div>
        </div>
      `;
      chatList.appendChild(container);
    }

    if (unseenCount > previousUnseen && Notification.permission === "granted" && document.hidden) {
      new Notification("üîî New Message!", {
        body: `${unseenCount} new message(s) in your inbox.`,
      });
    }
    previousUnseen = unseenCount;
  });

  function toggleMenu(btn) {
    const menu = btn.parentElement.querySelector(".menu");
    document.querySelectorAll(".menu").forEach(m => m.style.display = "none");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
  }

  function deleteChat(id) {
    if (confirm("Delete this chat?")) {
      firebase.database().ref("chats/" + user + "/" + id).remove();
    }
  }

  let activeChat = "";
  function openChat(id) {
    activeChat = id;
    document.getElementById("chatView").style.display = "block";
    const box = document.getElementById("chatBox");
    box.innerHTML = "";
    const msgRef = firebase.database().ref("chats/" + user + "/" + id + "/messages");
    msgRef.off();
    msgRef.on("child_added", snap => {
      const msg = snap.val();
      const div = document.createElement("div");
      div.style = `background:${msg.from === user ? '#b2ebf2' : '#ffe082'};margin:5px;padding:10px;border-radius:10px;color:#000;`;
      div.innerHTML = `<strong>${msg.from}</strong> (${msg.time}): <br>${msg.text}`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    });
    firebase.database().ref("chats/" + user + "/" + id + "/seen").set(true);
  }

  function closeChat() {
    document.getElementById("chatView").style.display = "none";
    activeChat = "";
  }

  function sendReply() {
    const msg = document.getElementById("replyBox").value.trim();
    if (!msg || !activeChat) return;
    const now = new Date().toLocaleString();
    firebase.database().ref("chats/" + user + "/" + activeChat + "/messages").push({
      from: user,
      text: msg,
      time: now
    });
    document.getElementById("replyBox").value = "";
  }

  function changeUsername() {
    const newU = document.getElementById("newUsername").value.trim();
    const pass = document.getElementById("currentPassword").value.trim();
    const status = document.getElementById("status");
    if (!newU || !pass) return alert("Fill all fields");

    const oldRef = firebase.database().ref("users/" + user);
    oldRef.once("value").then(snapshot => {
      if (snapshot.val().password !== pass) {
        status.textContent = "‚ùå Incorrect password.";
        return;
      }
      const newRef = firebase.database().ref("users/" + newU);
      newRef.once("value").then(snap => {
        if (snap.exists()) {
          status.textContent = "‚ùå Username already taken.";
        } else {
          newRef.set({ password: pass, lastSeen: new Date().toISOString() });
          firebase.database().ref("chats/" + user).once("value").then(data => {
            firebase.database().ref("chats/" + newU).set(data.val() || {});
            firebase.database().ref("chats/" + user).remove();
            oldRef.remove();
            localStorage.setItem("loggedInUser", newU);
            alert("Username updated. Refreshing...");
            location.reload();
          });
        }
      });
    });
  }

  if (Notification.permission !== "granted") {
    Notification.requestPermission();
  }
</script>
</body>
</html>